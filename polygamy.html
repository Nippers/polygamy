<body>
<h1>Economics of Polygamy</h1>
<h3>(Accompanying the paper <i>Computer Modeling of Polygamous Marriage Markets)</i></h3>
Select Incentives:
<select id="incentive" onchange="reset()">
  <option value="1">no marriage efficiency</option>
  <option value="2">maximize quantity of spouses</option>
  <option value="3">minimize quantity of spouses' spouses</option>
  <option value="4">Audi</option>
</select>
<br>
<canvas id="canvas" style="border:1px solid black;float:left;"></canvas>
<br><br>
<div id="record" style="border:1px solid black; width:700px;">
  <br><u>Record of marriages and divorces:</u><br>
  <div id="textnode"></div>
</div>
<script async src="//jsfiddle.net/Nipperz/p2pzw2q0/1/embed/"></script>

</body>

<script>



(function() {
  var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
  window.requestAnimationFrame = requestAnimationFrame;
})();

var canvas = document.getElementById("canvas"),
  ctx = canvas.getContext("2d"),
  width = 700,
  height =400;

boy_count = 21;
girl_count = 21;
boy_color = "rgba(0, 0, 255,.5)";
girl_color = "rgba(255, 0, 0,.5)";
people_size = 20;

var incentive = document.getElementById("incentive").value;

boxes = [];
// dimensions
for (var i = 0; i < boy_count; i++) {
  boxes.push({
    x: Math.floor((Math.random() * width) + 0),
    y: Math.floor((Math.random() * height) + 0),
    width: i*2+2+5,
    height: i*2+2+5,
    marriages: 0,
    wives: new Array (),
    income: i*2+2 //even numbers for boys
  });
}

chicks = [];
for (var k = 0; k < girl_count; k++) {
  chicks.push({
    x: Math.floor((Math.random() * width) + 0),
    y: Math.floor((Math.random() * height) + 0),
    width: k*2+1+5,
    height: k*2+1+5,
    marriages: 0,
    husbands: new Array (),
    income: k*2+1 //odd numbers for girls
  });
}

var girl_graph = [];
for (var l = 0; l < girl_count; l++) {
  girl_graph.push({
    x:(10 + (l*10)),
    y: 0,
    width: 7,
    //height: chicks[l].marriages*10
  });
}

var boy_graph = [];
for (var m = 0; m < boy_count; m++) {
  boy_graph.push({
    x:(width/2 + (m*10)),
    y: 0,
    width: 7,
    //height: chicks[l].marriages*10
  });
}
canvas.width = width;
canvas.height = height;

list = [];
var scale = 1.9

function update() {

  ctx.clearRect(0, 0, width, height);
  ctx.beginPath();

ctx.fillStyle = "white";
ctx.fillRect(0,0,width,height);

  // collision detect
if(incentive===1){
  for (var i = 0; i < chicks.length; i++) {
    for (var j = 0; j < boxes.length; j++) {
      var dir = colCheck(chicks[i], boxes[j]);
      if (dir !== null) {
        if (((boxes[j].income + chicks[i].income)/2) > boxes[j].income && ((boxes[j].income + chicks[i].income)/2) > chicks[i].income) {
        if (chicks[i].marriages < 1){
          chicks[i].marriages++;
        } else {
        		list.push(" M" + boxes.indexOf(chicks[i].husbands[0]) + "-W"+i);
            chicks[i].husbands[0].marriages--;
            chicks[i].husbands.splice(0,1);

        }
        chicks[i].husbands.push(boxes[j]);
        boxes[j].marriages++;
        boxes[j].wives.push(chicks[i]);
        list.push(" m"+j+"&w"+i);
        }
        }
      }
  }
}else if(incentive===2){
  for (var i = 0; i < chicks.length; i++) {
  for (var j = 0; j < boxes.length; j++) {
    var dir = colCheck(chicks[i], boxes[j]);
    if (dir !== null) {
      if (((boxes[j].income+chicks[i].income)/scale > boxes[j].income) && ((boxes[j].income+chicks[i].income)/scale > chicks[i].income)) {
      if (chicks[i].husbands.indexOf(boxes[j]) === -1){
      chicks[i].marriages++;
      chicks[i].husbands.push(boxes[j]);
      boxes[j].marriages++;
      boxes[j].wives.push(chicks[i]);
      list.push(" m"+j+"&w"+i);
      }
      }
      }
    }
}
}

//check if an equilibrium has been reached by figuring out if any women could do better by switching husbands.
//--------------------------------------------------------------------------------
if(incentive==="1"){
  var equilibrium_reached = true;
loop1:
for (i=0; i < chicks.length; i++){
  loop2:
  for (j=0; j < boxes.length; j++){
    if (chicks[i].marriages>0){
      if (boxes[j].income/(boxes[j].marriages+1) > chicks[i].husbands[0].income/chicks[i].husbands[0].marriages){
      equilibrium_reached = false;
      break loop1;
    } else {
        equilibrium_reached = true;
        }
        } else {
            equilibrium_reached = false;
            break loop1;
        }
      }
  }
}else if(incentive==="2"){
  var equilibrium_reached = true;
loop1:
for (i=0; i<chicks.length; i++){
loop2:
  for (j=0; j<boxes.length; j++){
    if ((chicks[i].husbands.indexOf(boxes[j]) === -1) && ((boxes[j].income + chicks[i].income)/scale) > (boxes[j].income) && (((boxes[j].income+chicks[i].income)/scale) > (chicks[i].income))){
      equilibrium_reached = false;
      break loop1;
    } else {
        equilibrium_reached = true;
        }
     }
  }
}

//add 'equilibrium reached' once to the end of the list if an equilibrium has been reached
  if (equilibrium_reached === true){
  	if (list[list.length-1] !== " Equilibrium Reached"){
  		list.push(" Equilibrium Reached");
      }
  }

//write out list under canvas
  textnode.style.fontSize = "small";
  marriage_string = list.toString();
	textnode.textContent = marriage_string;


//make girls move randomly
for(i = 0; i < chicks.length; i++){
  //if(chicks[i].marriages < 1){
        RandomMovement(chicks[i]);
        chicks[i].y = ypos;
        chicks[i].x = xpos;
    for(j = 0; j < chicks[i].husbands.length; j++){
//draw lines between spouses
    	ctx.beginPath();
			ctx.moveTo(chicks[i].x,chicks[i].y);
			ctx.lineTo(chicks[i].husbands[j].x, chicks[i].husbands[j].y);
      ctx.lineWidth=.5;
			ctx.stroke();
    }
}

  // make boy boxes move randomly
  for (var j = 0; j < boxes.length; j++) {
    RandomMovement(boxes[j]);
    boxes[j].x = xpos;
    boxes[j].y = ypos;
  }

  // fill in boys
  for (var i = 0; i < boxes.length; i++) {
    ctx.fillStyle = boy_color;
    ctx.fillRect(boxes[i].x, boxes[i].y, boxes[i].width, boxes[i].height);
  }
//fill in girls
  for (var i = 0; i < chicks.length; i++) {
    ctx.fillStyle = girl_color;
    ctx.fillRect(chicks[i].x, chicks[i].y, chicks[i].width, chicks[i].height);
  }

//fill in girl graph
  for (var i = 0; i < girl_graph.length; i++) {
    ctx.fillStyle = "rgba(250,0,0,.2)";
    ctx.fillRect(girl_graph[i].x, girl_graph[i].y, girl_graph[i].width, (2 + chicks[i].marriages*10));
  }

//fill in boy graph
  for (var i = 0; i < boy_graph.length; i++) {
    ctx.fillStyle = "rgba(0,0,250,.2)";
    ctx.fillRect(boy_graph[i].x, boy_graph[i].y, boy_graph[i].width, (2 + boxes[i].marriages*10));
  }

  requestAnimationFrame(update);
}



function colCheck(shapeA, shapeB) {
  // get the vectors to check against
  var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
    vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
    // add the half widths and half heights of the objects
    hWidths = (shapeA.width / 2) + (shapeB.width / 2),
    hHeights = (shapeA.height / 2) + (shapeB.height / 2),
    colDir = null;

  // if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision
  if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
    // figures out on which side we are colliding (top, bottom, left, or right)
    var oX = hWidths - Math.abs(vX),
      oY = hHeights - Math.abs(vY);
    if (oX >= oY) {
      if (vY > 0) {
        colDir = "t";
        shapeA.y += oY;
      } else {
        colDir = "b";
        shapeA.y -= oY;
      }
    } else {
      if (vX > 0) {
        colDir = "l";
        shapeA.x += oX;
      } else {
        colDir = "r";
        shapeA.x -= oX;
      }
    }
  }
  return colDir;
}


function RandomMovement(square) {

  speed = 2;
  var y_speed = Math.random() * (speed - -speed) + -speed;
  var x_speed = Math.random() * (speed - -speed) + -speed;

  if (square.y < canvas.height - square.height) {
    square.y = square.y + y_speed;
  } else {
    square.y = square.y - Math.abs(y_speed);
  }
  if (square.x < canvas.width - square.width) {
    square.x = square.x + x_speed;
  } else {
    square.x = square.x - Math.abs(x_speed);
  }
  if (square.y > 0) {
    square.y = square.y + y_speed;
  } else {
    square.y = square.y + Math.abs(y_speed);
  }
  if (square.x > 0) {
    square.x = square.x + x_speed;
  } else {
    square.x = square.x + Math.abs(x_speed);
  }
  xpos = square.x;
  ypos = square.y;
  return xpos, ypos;
}

window.addEventListener("load", function() {
  update();
});

function reset(){
  for(i=0;i<boxes.length;i++){
    boxes[i].marriages=0;
    boxes[i].wives=[];
  }
  for(i=0;i<chicks.length;i++){
    chicks[i].marriages=0;
    chicks[i].husbands=[];
  }
  list=[];
}

</script>
